# Payment Processor System - Architecture & Flow

## System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Admin Dashboard                          │
│                                                             │
│  Settings → Payment Processors                             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│           Payment Processor Settings Page                    │
│        (resources/views/admin/settings/payment_processors)   │
│                                                             │
│  ┌─────────────────┐  ┌──────────────────┐               │
│  │ Active Selector │  │ Global Settings  │               │
│  └────────┬────────┘  └──────────────────┘               │
│           │                                               │
│  ┌────────▼──────────────────────────────────────────┐   │
│  │   Flutterwave    │    Paystack     │  Status      │   │
│  │   Config Panel   │   Config Panel  │  Indicators  │   │
│  └─────────────────────────────────────────────────┬─┘   │
└─────────────────────────────────────────────────────┼─────┘
                                                      │
                                                      ↓
                      ┌───────────────────────────────────────┐
                      │   SettingController                   │
                      │                                       │
                      │ • paymentProcessors()                 │
                      │ • setActivePaymentProcessor()         │
                      │ • savePaymentProcessor()              │
                      │ • savePaymentGlobalSettings()         │









































































































































































































































































































































































































































































































**Version**: 1.0**Date**: January 12, 2026  **Architecture Documentation**  ---```         └─────────────────────────────┘         │ or Success Page             │         │ Redirect to Payment Form    │         ┌─────────────────────────────┐                    ↓                    │         └──────────┬──────────────────┘         │ Set Status: Pending         │         │ Create Payment Record       │         ┌─────────────────────────────┐                    ↓                    │         └──────────┬──────────────────┘         │ API                         │         │ Send to Payment Processor   │         ┌─────────────────────────────┐                    ↓                    │         └──────────┬──────────────────┘         │ Payment Request             │         │ Get API Keys & Configure    │         ┌─────────────────────────────┐                       ↓                       │            └──────────┬───┴──────────────┘            │              │              │         Test Mode    Sandbox/Test    Live            ↓              ↓              ↓            │              │              │            ┌──────────────┼──────────────┐                           │                └──────────┬───────────┘                │ Live/Sandbox/Test    │                │ Environment?         │                ┌──────────────────────┐                          ↓                          │        └─────────────────┬──┴────┬─────────────────┘        │                   │   │                   │                      Not Conf                             Not Conf      Use FW          Error: Try PS            Use PS      Error:        ↓                   ↓   ↓                   ↓        │                   │   │                   │       YES                  NO YES                  NO        │                   │   │                   │        ┌─────────┴─────────┐   ┌─────────┴─────────┐                  │                       │         └────────┬───────────┘ └────────┬───────────┘         │  Configured?       │ │    Configured?     │         │  Flutterwave       │ │    Paystack        │         ┌────────────────────┐ ┌────────────────────┐                    ↓                     ↓                    │                     │                    ┌──────────┴──────────┐                               │                    └──────────┬──────────────┘                    │ from config             │                    │ Get Active Processor    │                    ┌─────────────────────────┐                               ↓                               │                    └──────────┬──────────┘                    │ Payment Requested   │                    ┌─────────────────────┐```## Decision Tree for Payment Processing---```          └─ PaymentProcessorService::verifyWebhookSignature()       └─ config/payment.php : webhook_secret    └─ PAYMENT_WEBHOOK_SECRET    │    │     └─ PaymentProcessorService::getCurrency()    │  └─ config/payment.php : currency    ├─ PAYMENT_CURRENCY    │    │     └─ PaymentProcessorService::getSecretKey() [if active]    │  └─ config/payment.php : paystack.secret_key    ├─ PAYSTACK_SECRET_KEY    │    │     └─ PaymentProcessorService::getPublicKey() [if active]    │  └─ config/payment.php : paystack.public_key    ├─ PAYSTACK_PUBLIC_KEY    │    │     └─ PaymentProcessorService::getSecretKey() [if active]    │  └─ config/payment.php : flutterwave.secret_key    ├─ FLUTTERWAVE_SECRET_KEY    │    │     └─ PaymentProcessorService::getPublicKey() [if active]    │  └─ config/payment.php : flutterwave.public_key    ├─ FLUTTERWAVE_PUBLIC_KEY    │    │     └─ PaymentProcessorService::getActiveProcessor()    │  └─ config/payment.php : active_processor    ├─ PAYMENT_ACTIVE_PROCESSOR    │.env File```## Environment Variable Dependency Tree---```               └─ ... more utilities               ├─ formatAmount()               ├─ verifyWebhookSignature()               ├─ getPublicKey()               ├─ getActiveProcessor()           └─ PaymentProcessorService           │       └─ Payment Utilities       │       │              └─ Save to .env       │          └─ Read config/payment.php       │      └─ paymentProcessors()       │  └─ SettingController       │  │       ├─ Settings Management       │       │          └─ PaymentProcessorService::verifyWebhookSignature()       │      └─ handleNotification()       │  └─ WebhookController       │  │       │  │           └─ Call Flutterwave or Paystack API       │  │       └─ PaymentProcessorService::getActiveProcessor()       │  │   └─ createPayment()       │  ├─ PaymentController       │  │       ├─ Payment Processing       │Your Application```## Integration Point in Your App---```└──────────────────────────────────────────────────────────────┘│  Page auto-reloads after 5 seconds                         ││                                                              ││  Redirect with Success Message                              │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  New values from .env now available throughout app         ││                                                              ││  config/payment.php Reloaded                                │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  Forces Laravel to reload config from .env                 ││                                                              ││  artisan config:clear                                      ││                                                              ││  Laravel Configuration Cache Clear                          │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  3. Write updated .env file                                ││  2. Update or append key=value pairs                       ││  1. Read .env file                                         ││                                                              ││  SettingController::updateEnv()                              │┌──────────────────────────────────────────────────────────────┐         ↓         │    Processing    Errors    Continue      Show         ↓            ↓         │            │    ✅ Valid    ❌ Invalid         │            │         ┌─────┴─────┐               │└──────────────┬───────────────────────────────────────────────┘│  - Correct data types                                       ││  - Valid environment values                                 ││  - Required fields present                                  ││  Validate:                                                  ││                                                              ││  Laravel Request Validation                                 │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  Form submitted with new values                             │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  Admin updates payment processor settings                    │┌──────────────────────────────────────────────────────────────┐```## Configuration Update Flow---```   Mark Complete   Send Email   Update DB     Log & Ignore       ↓             ↓       │             │      Valid        Invalid         │            │         ┌─────┴─────┐               │└──────────────┬───────────────────────────────────────────────┘│  3. Return true/false                                      ││  2. Compare with signature                                 ││  1. Generate hash of body                                  ││  Using processor's secret key:                             ││                                                              ││  PaymentProcessorService::verifyWebhookSignature()           │┌──────────────────────────────────────────────────────────────┐       ↓       │   Payment      Log Error   Process      Reject &       ↓             ↓       │             │      Valid        Invalid         │            │         ┌─────┴─────┐               │└──────────────┬───────────────────────────────────────────────┘│  3. Verify signature using PaymentProcessorService         ││  2. Get request body                                       ││  1. Get signature from header                              ││                                                              ││  WebhookController::handlePaymentNotification()              │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│     }                                                       ││       ...                                                   ││       "status": "success",                                  ││       "amount": 10000,                                      ││       "transaction_id": "...",                              ││     {                                                       ││     Body:                                                   ││     - x-signature: [signed_hash]                            ││     Headers:                                                ││     POST /webhook/payment-notification                      ││                                                              ││     Send Webhook Notification                               │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│     Transaction completed                                   ││                                                              ││     Payment Processor (Flutterwave/Paystack)                │┌──────────────────────────────────────────────────────────────┐```## Webhook Processing Flow---```    Success Page   Error Page         ↓            ↓         │            │    ✅ Success    ❌ Failed         │            │         ┌─────┴─────┐               │└──────────────┬───────────────────────────────────────────────┘│  5. Redirect to success/failure page                       ││  4. Send confirmation email                                ││  3. Create invoice/receipt                                 ││  2. Update payment record in database                      ││  1. Verify payment with processor's API                    ││                                                              ││  Your Application Handles Callback                           │┌──────────────────────────────────────────────────────────────┐              ↓              │         └─────┬──────┘         │            │    └────┬───┘    └────┬───┘    │Callback│    │Callback│    │Success │    │ Failed │    ┌────────┐    ┌────────┐         ↓            ↓         │            │    ✅ Success    ❌ Failed         │            │         ┌─────┴─────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  Flutterwave or Paystack processes payment                 ││                                                              ││  Payment Processor API                                       │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  User enters payment details and completes payment           │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  }                                                           ││    • Use Paystack Inline                                    ││  } elseif (processor === 'paystack') {                      ││    • Use Flutterwave Inline or Hosted                       ││  if (processor === 'flutterwave') {                         ││                                                              ││  Show payment form with appropriate processor's SDK          │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  4. Render payment form                                     ││  3. Get currency and amount                                 ││  2. Get active processor public key                         ││  1. Get quote details                                       ││                                                              ││  PaymentController::showPaymentForm()                        │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  User chooses to pay for a quote                            ││                                                              ││              Customer Payment Page                           │┌──────────────────────────────────────────────────────────────┐```## Payment Processing Flow---```└──────────────────────────────────────────────────────────────┘│  Success message displays and fades after 5 seconds          ││  Page reloads with updated config                            │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  with success message                                       ││  Redirect to /admin/settings/payment-processors              │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  4. Redirect with success message                           ││  3. Clear config cache                                      ││  2. Update .env file with new values                        ││  1. Validate form data                                      ││                                                              ││  SettingController::savePaymentProcessor('flutterwave')      │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  PUT /admin/settings/payment-processors/flutterwave         ││  Form submitted to route:                                    │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  Example: Save Flutterwave config                           ││                                                              ││  User Action: Fill form and submit                           │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  • Show documentation and tips                              ││  • Show global settings form                                ││  • Show Paystack config form                                ││  • Show Flutterwave config form                             ││  • Show active processor selector                           ││                                                              ││  Render: payment_processors.blade.php                        │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  6. Pass to view                                            ││  5. Check processor configuration status                    ││  4. Load global payment settings                            ││  3. Load Paystack config                                    ││  2. Load Flutterwave config                                 ││  1. Get active processor from config                        ││                                                              ││  SettingController::paymentProcessors()                      │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│  Admin visits: /admin/settings/payment-processors             │┌──────────────────────────────────────────────────────────────┐               ↓               │└──────────────┬───────────────────────────────────────────────┘│        (Configure payment processors)                        ││                  User Action                                 │┌──────────────────────────────────────────────────────────────┐```## Request Flow Diagram---```                    └───────────────────────────────────┘                    │ • Customer notified               │                    │ • Payment status updated          │                    │ • Webhook notification received   │                    │ • Transaction recorded            │                    │                                   │                    │  Payment Processing Complete      │                    ┌───────────────────────────────────┐                                  ↓                    └─────────────┬─────────────┘                    │                           │        └──────────────────────┘   └──────────────────────┘        │ Handle Webhooks      │   │ Handle Webhooks      │        │ GET /transactions    │   │ initialize           │        │ POST /transactions   │   │ POST /transaction/   │        │                      │   │                      │        │   Flutterwave API    │   │   Paystack API       │        ┌──────────────────────┐   ┌──────────────────────┐                    ↓                           ↓                    ┌─────────────┴─────────────┐                                  │                      └───────────┬───────────────────────────┘                      │ processor's API                       │                      │ Process payments using selected       │                      │                                       │                      │  Your Payment Logic                   │                      ┌───────────────────────────────────────┐                                  ↓                                  │                      └───────────┬───────────────────────────┘                      │ • ... and more utilities              │                      │ • formatAmount()                      │                      │ • verifyWebhookSignature()            │                      │ • getPublicKey()                      │                      │ • getActiveProcessor()                │                      │                                       │                      │ PaymentProcessorService               │                      ┌───────────────────────────────────────┐                                  ↓                                  │                      └───────────┬───────────────────────────┘                      │ Reads from .env and provides config   │
                      │                                       │                      │  config/payment.php                   │                      ┌───────────────────────────────────────┐                                  ↓                                  │                      └───────────┬───────────────────────────┘                      │ PAYMENT_CURRENCY=...                 │                      │ PAYSTACK_SECRET_KEY=...              │                      │ PAYSTACK_PUBLIC_KEY=...              │                      │ FLUTTERWAVE_SECRET_KEY=...           │                      │ FLUTTERWAVE_PUBLIC_KEY=...           │                      │ PAYMENT_ACTIVE_PROCESSOR=...         │                      │                                       │                      │  .env File Updates                    │                      ┌───────────────────────────────────────┐                                  ↓                                  │                      └───────────┬───────────────────────────┘
